<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Couple Sync</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background: #ffe0ec;
      text-align: center;
    }
    textarea {
      width: 100%;
      height: 150px;
      font-size: 1rem;
      padding: 1rem;
      border-radius: 10px;
      border: 1px solid #ccc;
    }
    button {
      margin-top: 1rem;
      padding: 1rem 2rem;
      border: none;
      border-radius: 10px;
      background: #ff5c8a;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .hidden { display: none; }
    input[type=text] {
      padding: 0.5rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <h1>Couple Shared Note ðŸ’ž</h1>
  
  <div id="start">
    <p>Cosa vuoi fare?</p>
    <button onclick="createNewCouple()">ðŸ’Œ Crea nuova coppia</button>
    <p>oppure</p>
    <input type="text" id="codeInput" placeholder="Incolla codice coppia o link..." />
    <button onclick="joinCouple()">ðŸ”— Unisciti</button>
  </div>

  <div id="sharedArea" class="hidden">
    <p>Testo sincronizzato:</p>
    <textarea id="sharedText" placeholder="Scrivete qui..."></textarea>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    // 1. CONFIGURA FIREBASE QUI:
    const firebaseConfig = {
      apiKey: "TUO_API_KEY",
      authDomain: "TUO_DOMINIO.firebaseapp.com",
      projectId: "TUO_PROJECT_ID",
      storageBucket: "TUO_BUCKET.appspot.com",
      messagingSenderId: "NUMERO",
      appId: "ID_APP"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    let coupleCode = urlParams.get('code');

    const startDiv = document.getElementById("start");
    const sharedDiv = document.getElementById("sharedArea");
    const textArea = document.getElementById("sharedText");

    // Se Ã¨ presente un codice, entra nella coppia
    if (coupleCode) {
      startDiv.classList.add("hidden");
      sharedDiv.classList.remove("hidden");

      const docRef = db.collection("couples").doc(coupleCode);

      docRef.onSnapshot(doc => {
        const data = doc.data();
        if (data && data.text !== textArea.value) {
          textArea.value = data.text;
        }
      });

      textArea.addEventListener("input", () => {
        docRef.set({ text: textArea.value });
      });
    }

    // Funzione per creare una nuova coppia
    function createNewCouple() {
      const newCode = Math.random().toString(36).substring(2, 8);
      const newUrl = `${window.location.origin}${window.location.pathname}?code=${newCode}`;
      window.location.href = newUrl;
    }

    // Funzione per unire alla coppia con codice
    function joinCouple() {
      const input = document.getElementById("codeInput").value.trim();
      let code = "";

      // Se incolla direttamente l'URL
      if (input.includes("?code=")) {
        const parsed = new URL(input);
        code = new URLSearchParams(parsed.search).get("code");
      } else {
        code = input;
      }

      if (code.length >= 4) {
        const newUrl = `${window.location.origin}${window.location.pathname}?code=${code}`;
        window.location.href = newUrl;
      } else {
        alert("Codice non valido");
      }
    }
  </script>
</body>
</html>

